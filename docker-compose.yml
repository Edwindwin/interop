version: '3.1'

services:
  discovery:
    container_name: consul
    image: consul:1.9
    ports:
      - "8500:8500"

  mysql-client:
    container_name: mysql-client
    image: mysql:8.0
    restart: always

    command: --default-authentication-plugin=mysql_native_password
    
    environment:
      MYSQL_ROOT_PASSWORD: "root"
      MYSQL_ROOT_LOGIN: "root"

    ports:
      - "3306:3306"

    volumes:
      - ./bdd/client/setup.sql:/docker-entrypoint-initdb.d/setup.sql
      - ./bdd/client/table.sql:/docker-entrypoint-initdb.d/table.sql
      - ./data/mysql:/var/lib/mysql

  mongo-vente:
    container_name: mongo-vente
    image: mongo:latest
    restart: always

    environment:
      MONGO_INITDB_DATABASE: mongo_vente

    ports:
      - "27017:27017"
    volumes:
      - ./bdd/vente/setup-vente.js:/docker-entrypoint-initdb.d/setup-vente.js:ro
      - ./data/mongo:/data/db

  service-client:
    container_name: service-client
    image: service-client:latest
    restart: on-failure

    build:
      context: ./micro-client
      dockerfile: Dockerfile

    environment:
      - JAVA_TOOL_OPTIONS=
        -DCONSUL_HOST=discovery

    depends_on:
      - discovery
      - mysql-client

    ports:
      - "6868:8080"

volumes:
  data: